---
type Props = {
  images: string[];
  intervalMs?: number;
  class?: string;
};

const { images, intervalMs = 5000, class: className = "" } = Astro.props;

if (!images || images.length === 0) {
  throw new Error("HeroSlideshow requires a non-empty images[] prop.");
}

const heroId = `ny-hero-${Math.random().toString(36).slice(2)}`;
---

<section id={heroId} class={`ny-hero ${className}`} data-hero>
  <div class="ny-hero__slides" aria-hidden="true">
    {images.map((src, i) => (
      <img
        class={`ny-hero__img ${i === 0 ? "is-active" : ""}`}
        src={src}
        alt=""
        loading={i === 0 ? "eager" : "lazy"}
        fetchpriority={i === 0 ? "high" : "auto"}
        decoding="async"
        width="1920"
        height="1080"
      />
    ))}
  </div>

  <div class="ny-hero__veil" aria-hidden="true"></div>

  <div class="ny-hero__content">
    <slot />
  </div>
</section>

<script is:inline define:vars={{ intervalMs, heroId }}>
  (() => {
    const root = document.getElementById(heroId);
    if (!root) return;

    const imgs = Array.from(root.querySelectorAll(".ny-hero__img"));
    if (imgs.length <= 1) return;

    const prefersReduced =
      window.matchMedia &&
      window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    if (prefersReduced) return;

    imgs.forEach((img, idx) => img.classList.toggle("is-active", idx === 0));

    let i = 0;
    const ms = Math.max(1500, Number(intervalMs) || 5000);

    // Preload the rest
    for (let k = 1; k < imgs.length; k++) {
      const src = imgs[k].getAttribute("src");
      if (src) {
        const pre = new Image();
        pre.src = src;
      }
    }

    const tick = () => {
      imgs[i].classList.remove("is-active");
      i = (i + 1) % imgs.length;
      imgs[i].classList.add("is-active");
      window.setTimeout(tick, ms);
    };

    window.setTimeout(tick, ms);
  })();
</script>

<style>
  .ny-hero {
    position: relative;
    border-radius: 18px;
    overflow: hidden;
    background: #000;
    min-height: clamp(420px, 54vh, 620px);
    box-shadow: var(--shadow-soft);
  }

  .ny-hero__slides {
    position: absolute;
    inset: 0;
  }

  .ny-hero__img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 900ms ease-in-out;
    will-change: opacity;
    transform: scale(1.01);
  }

  .ny-hero__img.is-active {
    opacity: 1;
  }

  .ny-hero__veil {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      rgba(247, 243, 238, 0.78) 0%,
      rgba(247, 243, 238, 0.58) 34%,
      rgba(247, 243, 238, 0.16) 70%,
      rgba(0, 0, 0, 0) 100%
    );
    pointer-events: none;
  }

  .ny-hero__content {
    position: relative;
    z-index: 1;
    padding: clamp(28px, 4.5vw, 54px);
    display: grid;
    align-content: center;
    min-height: inherit;
  }

  @media (max-width: 900px) {
    .ny-hero__content {
      padding: 24px 20px 26px;
    }

    .ny-hero__veil {
      background: linear-gradient(
        180deg,
        rgba(247, 243, 238, 0.84) 0%,
        rgba(247, 243, 238, 0.62) 55%,
        rgba(247, 243, 238, 0.18) 100%
      );
    }
  }
</style>
